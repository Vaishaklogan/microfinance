<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">

<head>
    <title>Weekly Collection Report</title>

    <!-- Bootstrap -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">

    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        body {
            background-color: #f4f6f9;
        }
        
        #chart {
            max-width: 500px;
            margin: auto;
            pointer-events: none;
            user-select: none;
        }
    </style>
</head>

<body>

    <div class="container mt-4">

        <!-- Header -->
        <div class="mb-4 text-center">
            <h3 class="fw-bold">Weekly Collection Report</h3>
            <p class="text-muted">View & download weekly finance summary</p>
        </div>

        <!-- Date Selector -->
        <form method="post" class="row g-3 mb-4 justify-content-center">
            <div class="col-md-4">
                <label class="form-label">Select Sunday</label>
                <input type="date" name="date" class="form-control" required>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button class="btn btn-primary w-100">View Report</button>
            </div>
        </form>

        <!-- Report Section -->
        <div th:if="${total != null}" id="reportData" th:data-labels="${groups.keySet()}" th:data-values="${groups.values()}">

            <!-- Total -->
            <div class="alert alert-success text-center fs-5">
                Total Amount Collected : ₹ <strong th:text="${total}"></strong>
            </div>

            <!-- Download -->
            <div class="text-center mb-4">
                <a th:href="@{/reports/weekly/excel(date=${date})}" class="btn btn-success">
                Download Excel
            </a>
            </div>

            <!-- Table -->
            <div class="table-responsive mb-5">
                <table class="table table-bordered table-striped">
                    <thead class="table-dark">
                        <tr>
                            <th>Group Name</th>
                            <th>Amount Collected</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr th:each="g : ${groups}">
                            <td th:text="${g.key}"></td>
                            <td th:text="${g.value}"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <!-- Chart -->
            <div class="text-center">
                <h5 class="mb-3">Group-wise Collection (Chart)</h5>
                <canvas id="chart"></canvas>
            </div>

        </div>

    </div>

    <!-- ✅ PURE JAVASCRIPT (NO THYMELEAF SYNTAX INSIDE JS) -->
    <script>
        const container = document.getElementById("reportData");
        if (container) {
            const labels = container.dataset.labels
                .replace('[', '')
                .replace(']', '')
                .split(',');

            const values = container.dataset.values
                .replace('[', '')
                .replace(']', '')
                .split(',')
                .map(Number);

            new Chart(document.getElementById('chart'), {
                type: 'pie',
                data: {
                    labels: labels,
                    datasets: [{
                        data: values,
                        backgroundColor: [
                            '#0d6efd',
                            '#198754',
                            '#ffc107',
                            '#dc3545',
                            '#6f42c1',
                            '#20c997'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'bottom'
                        }
                    },
                    interaction: {
                        mode: null
                    },
                    events: []
                }
            });
        }
    </script>

</body>

</html>